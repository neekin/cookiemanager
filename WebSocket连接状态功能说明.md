# WebSocket连接状态功能说明

## 新增功能

### 1. WebSocket连接状态显示
在客户端界面上添加了服务器连接状态指示器，实时显示与服务器的WebSocket连接状态：

- **已连接**: 显示为绿色 "服务器连接: 已连接"
- **未连接**: 显示为红色 "服务器连接: 未连接"

### 2. 自动重连功能
当WebSocket连接断开时，客户端会自动尝试重新连接：

- 每5秒自动尝试重连一次
- 连接成功后停止重连定时器
- 在状态栏显示连接状态和错误信息

### 3. 连接状态事件处理
完整的WebSocket生命周期管理：

- **OnOpen**: 连接建立时更新状态为已连接
- **OnMessage**: 处理服务器消息
- **OnError**: 连接错误时更新状态并启动重连
- **OnClose**: 连接关闭时更新状态并启动重连

### 4. 资源清理
窗口关闭时正确清理资源：

- 停止重连定时器
- 关闭WebSocket连接
- 释放HttpClient资源

## 界面变化

在原有的状态信息区域添加了WebSocket连接状态显示，位置在：
```
状态信息区域:
[服务器连接: 已连接/未连接] [客户端连接数: X] [后台任务: 活跃/未活跃] [已关闭实例数量: X] [当前处理索引: X]
```

## 技术实现

### 主要代码变化

1. **MainWindow.xaml**: 
   - 添加了 `WebSocketStatusTextBlock` 控件用于显示连接状态

2. **MainWindow.xaml.cs**:
   - 添加了 `isWebSocketConnected` 字段跟踪连接状态
   - 添加了 `reconnectTimer` 用于自动重连
   - 实现了 `UpdateWebSocketStatus()` 方法更新UI状态
   - 实现了 `StartReconnectTimer()` 方法处理自动重连
   - 在 `OnClosed()` 方法中添加资源清理

### 使用方法

1. 启动服务器：
   ```bash
   cd server
   node index.js
   ```

2. 运行客户端：
   ```bash
   cd client
   dotnet run
   ```

3. 观察连接状态：
   - 启动客户端时会自动尝试连接服务器
   - 如果服务器未运行，会显示"未连接"并持续重试
   - 服务器启动后会自动连接并显示"已连接"
   - 服务器关闭时会显示断开状态并开始重连

## 优势

1. **实时反馈**: 用户可以立即知道客户端是否与服务器保持连接
2. **自动恢复**: 网络故障或服务器重启后自动重新建立连接
3. **用户友好**: 清晰的视觉指示，避免用户困惑
4. **稳定性**: 合理的资源管理，避免内存泄漏

这个功能增强了应用程序的可靠性和用户体验，特别是在网络不稳定或服务器维护的情况下。
